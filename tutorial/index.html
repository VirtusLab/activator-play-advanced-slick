<html>
<head>
    <title>Play Slick with type-safe IDs - Activator Template</title>
</head>
<body>
<div>
    <p>
        You've just created an application with the Play Slick with type-safe IDs template. This template combines Play
        Framework with Slick and adds tools to use type-safe IDs for your classes so you can no longer join on bad id
        field or mess up order of fields in mappings. It also provides way to create repository with methods (like querying
        all, querying by id, saving or deleting), for all classes with such IDs in just 4 lines of code.

        Idea for type-safe ids was derived from Slick creator's <a
            href="http://www.parleys.com/play/51c2e20de4b0d38b54f46243/chapter63/about" target="_blank">presentation on
        ScalaDays 2013</a>.
    </p>

    <h2>Set up the database</h2>

    <p>
        The template you're using is already set up with an in-memory instance of the H2 database. You can leave this as
        it is and skip this section if you want to continue using this database.
    </p>

    <p>
        It is sometimes advantageous to use H2 in file mode rather than in memory. This will allow debugging through
        things like the h2-browser or other methods of access to H2. To make this change, edit the <a
            href="#code/conf/application.conf"
            class="shortcut">conf/application.conf</a>
        file and find the line that specifies the default url:

        <pre><code>db.default.url="jdbc:h2:mem:play"</code></pre>

        In order to use a file-based database, change this to

        <pre><code>db.default.url="jdbc:h2:/path/to/file</code></pre>

        You can then get access to the database by shutting down all processes (including Play) that are accessing it and
        using the following commands

        <pre><code>activator</code></pre>
        <pre><code>h2-browser</code></pre>

        And then enter the same URL to access H2.
    </p>

    <p>
        To use a different database technology, use the instructions on the <a
            href="https://www.playframework.com/documentation/2.4.x/ScalaDatabase">Play Documentation site</a>
    </p>

</div>

<div>
    <h2>Create tables</h2>

    <p>
        Play includes a function called <a
            href="https://www.playframework.com/documentation/2.4.x/Evolutions">evolutions</a> that allows the management
        of database schema changes. To use evolutions, create an evolutions folder for the default database as
        <code>conf/evolutions/default</code>
        then create .sql scripts that will put the database into the appropriate state. Evolutions also has the ability
        to revert the database to a previous version.

        In this example, evolution file is called conf/evolutions/default/1.sql with the following content:
    </p>

<pre><code># --- !Ups

create table "COMMENTS" (
"ID" BIGINT GENERATED BY DEFAULT AS IDENTITY(START WITH 1) NOT NULL PRIMARY KEY,
"TEXT" VARCHAR NOT NULL,
"AUTHOR" BIGINT NOT NULL,
"DATE" TIMESTAMP NOT NULL
);

create table "USERS" (
"ID" BIGINT GENERATED BY DEFAULT AS IDENTITY(START WITH 1) NOT NULL PRIMARY KEY,
"EMAIL" VARCHAR NOT NULL,
"FIRST_NAME" VARCHAR NOT NULL,
"LAST_NAME" VARCHAR NOT NULL
);

alter table "COMMENTS"
add constraint "COMMENTS_AUTHOR_FK"
foreign key("AUTHOR")
references "USERS"("ID");

# --- !Downs

alter table "COMMENTS" drop constraint "COMMENTS_AUTHOR_FK";
drop table "COMMENTS";
drop table "USERS";</code></pre>

    <p>
        When you load up your application, you will be prompted to apply the script(s).
    </p>

</div>

<div>
    <h2>Create the models</h2>

    <p>
        This template uses small library called <a href="https://github.com/VirtusLab/unicorn" target="_blank"><i>Unicorn</i></a>
        that enables usage of type safe primary and foreign keys in your application. Example entity created with this
        library can be shown <a href="#code/app/model/UserRow.scala" class="shortcut">here.</a>
    </p>

    <p>Entity declaration contains of four parts:</p>
    <ul>
        <li>Case class for your type-safe id. It has to mix <code>BaseId</code> and contain id field of type
            <code>Long</code>. It is also good to extend from <code>AnyVal</code> to get unboxed values.
        </li>
        <li>Companion object for your id. It have to extend <code>IdCompanion[YourEntityId]</code>. This step provides
            you with implicits needed in slick queries and Play! mappings.
        </li>
        <li>Your domain model entity. It has to <code>extend WithId[YourEntityId]</code>.</li>
        <li>Table definition for your entity. It <code>extends IdTable[YourEntityId, YourEntity]</code>, which
            accepts table name (and optionally schema name).
        </li>
    </ul>

    <p>
        All of those needs following imports to work:

<pre><code>import org.virtuslab.unicorn.LongUnicornPlay._
import org.virtuslab.unicorn.LongUnicornPlay.driver.api._</code></pre>

        Those loads definitions from cake baked for Play! and `Long` keys. You can bake your own cake if you want to
        change something, more on this later in tutorial.
    </p>

    <p>
        In case of any problems related to Slick its' site at <a href="http://slick.typesafe.com" target="_blank">slick.typesafe.com</a>
        has an excellent set of documentation.
    </p>

</div>

<div>
    <h2>Gain basic repository for free!</h2>

    <p>
        When you have entity declaration you get (almost) free basic repository methods for it. Example is
        shown in <a href="#code/app/repositories/UserRepository.scala" class="shortcut">UserRepository</a>.
        That one line of code enables you to save your entities, query or delete them by id and some more.
    </p>

    <p>
        Example usage can be shown in <a href="#code/test/repositories/UsersRepositoryTest.scala" class="shortcut">UsersRepositoryTest</a>.
    </p>
</div>

<div>
    <h2>Adding next class - type-safe joins</h2>

    <p>
        Let's add new class to our model. It will be a <a href="#code/app/model/CommentRow.scala"
                                                          class="shortcut">Comment</a>. With an exception of class names
        and fields it's the same as <a href="#code/app/model/UserRow.scala" class="shortcut">User</a>.
    </p>

    <p>
        In queries for comments (<a href="#code/app/repositories/CommentRepository.scala" class="shortcut">CommentRepository</a>)
        we can now create query joining on type-safe userId and method for searching comments by userId:
    </p>

<pre><code>import model.UserId
private[repositories] trait CommentQueries {
   //query
   private def commentsByAuthorIdQuery(authorId: Rep[UserId]) =
       for {
            comment <- Comments.query if comment.authorId === authorId
       } yield comment

   //compiled query
   protected lazy val commentsByAuthorIdQueryCompiled = Compiled(commentsByAuthorIdQuery _)
}

class CommentRepository
   extends BaseIdRepository[CommentId, CommentRow, Comments](Comments.query)
   with CommentQueries {

   //repository method using query from CommentQueries trait
   def findForAuthorId(authorId: UserId): DBIO[Seq[CommentRow]] = {
      commentsByAuthorIdQueryCompiled(authorId).result
   }
}
</code></pre>

    <p>
        At last, let's test your new repository in <a href="#code/test/repositories/CommentsRepositoryTest.scala" class="shortcut">CommentsRepositoryTest</a>:
    </p>

<pre><code>//when
val testCaseLogic = for {
    userId <- userRepo.save(userRow)
    comments = buildComments(userId)
    commentsIds <- commentRepo.saveAll(comments)
    queriedComments <- commentRepo.findForAuthorId(userId)
} yield (comments, commentsIds, queriedComments)

//then
createSchema.andThen(testCaseLogic).map {
   case (comments, commentsIds, queriedComments) =>
       queriedComments.size shouldEqual comments.size
       queriedComments.flatMap(_.id) should contain theSameElementsAs (commentsIds)
   }</code></pre>
</div>

<div>
    <h2>Additional goodies</h2>

    <p>
        Your type-safe IDs are designed not only to work with Slick, but also with Play! framework internals. You can
        also use them in mappings (beloved <a href="http://www.playframework.com/documentation/2.4.x/ScalaForms"
                                              target="_blank">Play! forms API</a>) and <a
            href="http://www.playframework.com/documentation/2.4.x/ScalaRouting" target="_blank">routes</a> without any
        added work and benefit from type-safety in you application.
    </p>

    <p>Using IDs in form mappings:</p>
    <pre><code>
val userMapping = Form(
    mapping(
        "id" -> of[UserId], // it will be read from Long and packed to UserId
        "email" -> email,
        "firstName" -> text,
        "lastName" -> text
    )(User.apply)(User.unappply)
)
    </code></pre>

    <p>Using IDs in routes:</p>
    <pre><code>
// it will be read from Long and packed to UserId, so you can use it like that in controller method
/user/show/:id      controllers.UsersController.show(id: model.UserId)
    </code></pre>
</div>

<div>
    <h2>Baking your own cake</h2>

    <p>
        If you want to use <code>unicorn</code> with other type of primary keys (not only <code>Long</code>s,
        or use it outside of Play! Framework you can bake your own cake instead of <code>LongUnicornPlay</code> one.

        For implementation details see <code>org.virtuslab.unicorn.LongUnicornPlay</code> and
        <code>org.virtuslab.unicorn.Unicorn</code>.
    </p>
</div>

<div>
    <h2>About Play! Framework</h2>

    <p>
        It is not a scope of this template to dwell into details of the Play! framework. If you have some questions or want to
        know more about it, you are welcome to browse Play! sources around the web.
    </p>

    <p>
        The <a href="http://www.playframework.com/documentation" target="_blank">Play Documentation</a> contains much
        more exhaustive details and also covers a number of other topics which haven't been addressed in this
        tutorial.<br/>
        <a href="http://stackoverflow.com" target="_blank">StackOverflow</a> is a great place ask questions about
        Play.<br/>
        <a href="http://groups.google.com/group/play-framework" target="_blank">The play-framework</a> Google Group is a
        great place to discuss Play.<br/>
    </p>
</div>

</body>
</html>
